"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("wonka"),t=require("graphql"),r=require("react"),n=require("react-wonka");function o(){return(o=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}var i=function(e,t){var r="";return void 0!==e?r="[Network] "+e.message:(void 0!==t&&t.forEach((function(e){r+="[GraphQL] "+e.message+"\n"})),r.trim())},a=function(e){return"string"==typeof e?new t.GraphQLError(e):"object"==typeof e&&e.message?new t.GraphQLError(e.message,e.nodes,e.source,e.positions,e.path,e.originalError,e.extensions||{}):e};function u(){return this.message}var c=function(e){function t(t){var r=t.networkError,n=t.response,o=(t.graphQLErrors||[]).map(a),u=i(r,o);e.call(this,u),this.name="CombinedError",this.message=u,this.graphQLErrors=o,this.networkError=r,this.response=n}return e&&(t.__proto__=e),(t.prototype=Object.create(e&&e.prototype)).constructor=t,t.prototype.toString=u,t}(Error),s=function(e,t){e|=0;for(var r=0,n=0|t.length;r<n;r++)e=(e<<5)+e+t.charCodeAt(r);return e},f=new Set,p=function(e){if(void 0===e)return"";if("number"==typeof e)return isFinite(e)?""+e:"null";if("object"!=typeof e)return JSON.stringify(e);if(null===e)return"null";var t="";if(Array.isArray(e)){t="[";for(var r=0,n=e.length;r<n;r++){r>0&&(t+=",");var o=p(e[r]);t+=o.length>0?o:"null"}return t+"]"}if(f.has(e))throw new TypeError("Converting circular structure to JSON");var i=Object.keys(e).sort();f.add(e),t="{";for(var a=0,u=i.length;a<u;a++){var c=i[a],s=p(e[c]);0!==s.length&&(t.length>1&&(t+=","),t+=p(c)+":"+s)}return f.delete(e),t+"}"},l=function(e){return f.clear(),p(e)},v=function(e){return t=e.replace(/[\s,]+/g," ").trim(),s(5381,t)>>>0;var t},h=Object.create(null),d=function(e,r){var n,o;return"string"==typeof e?(n=v(e),o=void 0!==h[n]?h[n]:t.parse(e)):void 0!==e.__key?(n=e.__key,o=e):(n=v(t.print(e)),o=void 0!==h[n]?h[n]:e),h[n]=o,o.__key=n,{key:r?s(n,l(r))>>>0:n,query:o,variables:r||{}}},y=function(e,t){return o(o({},e),{context:o(o({},e.context),{meta:o(o({},e.context.meta),t)})})},x=function(e,t,r){return{operation:e,data:t.data,error:Array.isArray(t.errors)?new c({graphQLErrors:t.errors,response:r}):void 0,extensions:"object"==typeof t.extensions&&null!==t.extensions?t.extensions:void 0}},m=function(e,t,r){return{operation:e,data:void 0,error:new c({networkError:t,response:r}),extensions:void 0}},g=function(e,t){if(void 0===t&&(t=[]),Array.isArray(e))e.forEach((function(e){g(e,t)}));else if("object"==typeof e&&null!==e)for(var r in e)if(Object.prototype.hasOwnProperty.call(e,r)){var n=e[r];"__typename"===r&&"string"==typeof n?t.push(n):"object"==typeof n&&null!==n&&g(n,t)}return t};function k(e,t,r){return r.indexOf(e)===t}var b=function(e){return g(e).filter(k)};function O(e){return"Field"===e.kind&&"__typename"===e.name.value}var w=function(e){return void 0!==e.selectionSet&&(e.selectionSet.selections.some(O)?e:o(o({},e),{selectionSet:o(o({},e.selectionSet),{selections:e.selectionSet.selections.concat([{kind:t.Kind.FIELD,name:{kind:t.Kind.NAME,value:"__typename"}}])})}))},q=function(e){return t.visit(e,{Field:w,InlineFragment:w})};function E(t){return t.toPromise=function(){return e.toPromise(e.take(1)(t))},t}var S=function(e){var t=e.operationName;return"subscription"!==t&&"query"!==t};function N(e){return""+e}var P=function(e){var t=e.error,r={data:e.data,error:void 0};return void 0!==t&&(r.error={networkError:""+t.networkError,graphQLErrors:t.graphQLErrors.map(N)}),r},C=function(e,t){var r=t.error,n={operation:e,data:t.data,extensions:void 0,error:void 0};return void 0!==r&&(n.error=new c({networkError:new Error(r.networkError),graphQLErrors:r.graphQLErrors})),n},j=function(e){var t=e.operationName;return"mutation"!==t&&"query"!==t};function M(e){return o(o({},e),{query:q(e.query)})}function _(e){return y(e,{cacheOutcome:"miss"})}function Q(e){return j(e)}var R=function(t){var r=t.forward,n=t.client,i=new Map,a=Object.create(null),u=M,c=I(i,a,n),s=L(i,a),f=function(e){var t=e.context.requestPolicy;return"query"===e.operationName&&"network-only"!==t&&("cache-only"===t||i.has(e.key))};function p(e){var t=i.get(e.key),r=o(o({},t),{operation:y(e,{cacheOutcome:t?"hit":"miss"})});return"cache-and-network"===e.context.requestPolicy&&(r.stale=!0,A(n,e)),r}function l(e){return!j(e)&&f(e)}function v(e){e.operation&&"mutation"===e.operation.operationName?c(e):e.operation&&"query"===e.operation.operationName&&s(e)}function h(e){return!j(e)&&!f(e)}return function(t){var n=e.share(t),o=e.map(p)(e.filter(l)(n)),i=e.tap(v)(r(e.map(_)(e.merge([e.map(u)(e.filter(h)(n)),e.filter(Q)(n)]))));return e.merge([o,i])}},A=function(e,t){return e.reexecuteOperation(o(o({},t),{context:o(o({},t.context),{requestPolicy:"network-only"})}))},I=function(e,t,r){function n(t){if(e.has(t)){var n=e.get(t).operation;e.delete(t),A(r,n)}}return function(e){var r=new Set;function o(e){r.add(e)}b(e.data).forEach((function(e){var r=t[e]||(t[e]=new Set);r.forEach(o),r.clear()})),r.forEach(n)}},L=function(e,t){return function(r){var n=r.operation,o=r.data;null!=o&&(e.set(n.key,{operation:n,data:o,error:r.error}),b(r.data).forEach((function(e){(t[e]||(t[e]=new Set)).add(n.key)})))}},V=function(e){return"subscription"===e.operationName};function D(e){return!V(e)}var F=function(t){var r=t.forward,n=new Set,o=function(e){var t=e.key,r=e.operationName;if("teardown"===r)return n.delete(t),!0;if("query"!==r)return!0;var o=n.has(t);return n.add(t),!o},i=function(e){n.delete(e.operation.key)};return function(t){var n=e.filter(o)(t);return e.tap(i)(r(n))}};function T(e){var t=e.operationName;return"query"===t||"mutation"===t}var $=function(t){var r=t.forward,n=T;function o(e){return!n(e)}return function(t){var i=e.share(t),a=e.mergeMap((function(t){var r=t.key,n=e.filter((function(e){return"teardown"===e.operationName&&e.key===r}))(i);return e.takeUntil(n)(J(t))}))(e.filter(n)(i)),u=r(e.filter(o)(i));return e.merge([a,u])}};function G(e){return e.kind===t.Kind.OPERATION_DEFINITION&&e.name}var J=function(r){return e.make((function(e){var n,i=e[0],a=e[1],u="undefined"!=typeof AbortController?new AbortController:void 0,c=r.context,s="function"==typeof c.fetchOptions?c.fetchOptions():c.fetchOptions||{},f=void 0!==(n=r.query.definitions.find(G))&&n.name?n.name.value:null,p={query:t.print(r.query),variables:r.variables};null!==f&&(p.operationName=f);var l=o(o({body:JSON.stringify(p),method:"POST"},s),{headers:o({"content-type":"application/json"},s.headers),signal:void 0!==u?u.signal:void 0});return K(r,l).then((function(e){void 0!==e&&i(e),a()})),function(){void 0!==u&&u.abort()}}))},K=function(e,t){var r,n=e.context;return(n.fetch||fetch)(n.url,t).then((function(e){var n=e.status;if(r=e,n<200||n>=("manual"===t.redirect?400:300))throw new Error(e.statusText);return e.json()})).then((function(t){return x(e,t,r)})).catch((function(t){if("AbortError"!==t.name)return m(e,t,r)}))};function U(){return!1}function z(e){}var B=function(t){return e.filter(U)(e.tap(z)(t))},H=function(e){return 1===e.length?e[0]:function(t){var r=t.client;return e.reduceRight((function(e,t){return t({client:r,forward:e})}),t.forward)}},W=[F,R,$],X=function(e){return new Y(e)},Y=function(t){var r=this;this.activeOperations=Object.create(null),this.createOperationContext=function(e){var t=(e||{}).requestPolicy;return void 0===t&&(t=r.requestPolicy),o(o({url:r.url,fetchOptions:r.fetchOptions,fetch:r.fetch},e),{requestPolicy:t})},this.createRequestOperation=function(e,t,n){return{key:t.key,query:t.query,variables:t.variables,operationName:e,context:r.createOperationContext(n)}},this.reexecuteOperation=function(e){(r.activeOperations[e.key]||0)>0&&r.dispatchOperation(e)},this.executeQuery=function(t,n){var o=r.createRequestOperation("query",t,n),i=r.executeRequestOperation(o),a=o.context.pollInterval;return a?e.switchMap((function(){return i}))(e.merge([e.fromValue(0),e.interval(a)])):i},this.executeSubscription=function(e,t){var n=r.createRequestOperation("subscription",e,t);return r.executeRequestOperation(n)},this.executeMutation=function(e,t){var n=r.createRequestOperation("mutation",e,t);return r.executeRequestOperation(n)},this.url=t.url,this.fetchOptions=t.fetchOptions,this.fetch=t.fetch,this.suspense=!!t.suspense,this.requestPolicy=t.requestPolicy||"cache-first";var n=e.makeSubject(),i=n[1];this.operations$=n[0];var a=[],u=!1;this.dispatchOperation=function(e){if(a.push(e),!u){var t;for(u=!0;void 0!==(t=a.shift());)i(t);u=!1}},this.exchange=H(void 0!==t.exchanges?t.exchanges:W),this.results$=e.share(this.exchange({client:this,forward:B})(this.operations$))};Y.prototype.onOperationStart=function(e){var t=e.key;this.activeOperations[t]=(this.activeOperations[t]||0)+1,this.dispatchOperation(e)},Y.prototype.onOperationEnd=function(e){var t=e.key,r=this.activeOperations[t]||0;(this.activeOperations[t]=r<=0?0:r-1)<=0&&this.dispatchOperation(o(o({},e),{operationName:"teardown"}))},Y.prototype.executeRequestOperation=function(t){var r=this,n=t.key,o=t.operationName,i=e.filter((function(e){return e.operation.key===n}))(this.results$);if("mutation"===o)return e.take(1)(e.onStart((function(){return r.dispatchOperation(t)}))(i));var a,u=e.filter((function(e){return"teardown"===e.operationName&&e.key===n}))(this.operations$),c=e.onEnd((function(){return r.onOperationEnd(t)}))(e.onStart((function(){return r.onOperationStart(t)}))(e.takeUntil(u)(i)));return!1!==t.context.suspense&&this.suspense&&"query"===o?(a=c,e.make((function(t){var r,n,o=t[0],i=t[1],u=!1,c=e.subscribe((function(e){void 0===r?n=e:u||(r(e),i(),c())}))(e.onEnd(i)(e.onPush(o)(a)))[0];if(void 0===n)throw new Promise((function(e){r=e}));return function(){u=!0,c()}}))):c},Y.prototype.query=function(e,t,r){return r&&"boolean"==typeof r.suspense||(r=o(o({},r),{suspense:!1})),E(this.executeQuery(d(e,t),r))},Y.prototype.mutation=function(e,t,r){return E(this.executeMutation(d(e,t),r))};var Z=X({url:"/graphql"}),ee=r.createContext(Z),te=ee.Provider,re=ee.Consumer,ne=function(){return r.useContext(ee)},oe=function(t){var n=ne(),o=r.useState({fetching:!1,stale:!1,error:void 0,data:void 0,extensions:void 0}),i=o[1];function a(e){return i({fetching:!1,stale:!!e.stale,data:e.data,error:e.error,extensions:e.extensions}),e}return[o[0],r.useCallback((function(r,o){i({fetching:!0,stale:!1,error:void 0,data:void 0,extensions:void 0});var u=d(t,r);return e.toPromise(n.executeMutation(u,o||{})).then(a)}),[n,t,i])]},ie=function(e,t){var n=r.useRef(void 0);return r.useMemo((function(){var r=d(e,t);return void 0!==n.current&&n.current.key===r.key?n.current:(n.current=r,r)}),[e,t])},ae={fetching:!1,stale:!1,data:void 0,error:void 0,extensions:void 0};function ue(e,t){return o(o(o({},e),{stale:!1}),t)}function ce(e){return{fetching:!1,stale:!!e.stale,data:e.data,error:e.error,extensions:e.extensions}}function se(t){return t?e.concat([e.fromValue({fetching:!0}),e.map(ce)(t),e.fromValue({fetching:!1})]):e.fromValue({fetching:!1})}function fe(t){return e.scan(ue,ae)(e.switchMap(se)(t))}var pe=function(e){var t=ne(),i=ie(e.query,e.variables);function a(r){return t.executeQuery(i,o(o({requestPolicy:e.requestPolicy,pollInterval:e.pollInterval},e.context),r))}var u=r.useMemo((function(){return a}),[t,i,e.requestPolicy,e.pollInterval,e.context]),c=n.useSubjectValue(fe,r.useMemo((function(){return e.pause?null:u()}),[e.pause,u]),ae),s=c[1];return[c[0],r.useCallback((function(e){return s(u(e))}),[s,u])]},le={fetching:!1,stale:!1,data:void 0,error:void 0,extensions:void 0};function ve(e){return{fetching:!0,stale:!!e.stale,data:e.data,error:e.error,extensions:e.extensions}}function he(t){return t?e.concat([e.fromValue({fetching:!0}),e.map(ve)(t),e.fromValue({fetching:!1})]):e.fromValue({fetching:!1})}var de=function(t,i){var a=ne(),u=r.useRef(i);u.current=i;var c=ie(t.query,t.variables);function s(e){return a.executeSubscription(c,o(o({},t.context),e))}var f=r.useMemo((function(){return s}),[a,c,t.context]);function p(e,t){var r=u.current,n=void 0!==t.data?"function"==typeof r?r(e.data,t.data):t.data:e.data;return o(o(o(o({},e),{stale:!1}),t),{data:n})}var l=n.useSubjectValue((function(t){return e.scan(p,le)(e.switchMap(he)(t))}),r.useMemo((function(){return t.pause?null:f()}),[t.pause,f]),le),v=l[1];return[l[0],r.useCallback((function(e){return v(f(e))}),[v,f])]};exports.Client=Y,exports.CombinedError=c,exports.Consumer=re,exports.Context=ee,exports.Mutation=function(e){var t=e.children,r=oe(e.query),n=r[1];return t(o(o({},r[0]),{executeMutation:n}))},exports.Provider=te,exports.Query=function(e){var t=pe(e),r=t[1];return e.children(o(o({},t[0]),{executeQuery:r}))},exports.Subscription=function(e){var t=de(e,e.handler),r=t[1];return e.children(o(o({},t[0]),{executeSubscription:r}))},exports.cacheExchange=R,exports.composeExchanges=H,exports.createClient=X,exports.createRequest=d,exports.debugExchange=function(e){var t=e.forward;return function(e){return t(e)}},exports.dedupExchange=F,exports.defaultExchanges=W,exports.fallbackExchangeIO=B,exports.fetchExchange=$,exports.formatDocument=q,exports.makeErrorResult=m,exports.makeResult=x,exports.ssrExchange=function(t){var r={},n=function(e){return!S(e)&&void 0!==r[e.key]};function i(e){return!n(e)}function a(e){return C(e,r[e.key])}function u(e){return n(e)}function c(e){var t=e.operation;if(!S(t)){var n=P(e);r[t.key]=n}}function s(e){delete r[e.operation.key]}var f=function(r){var n=r.client,o=r.forward;return function(r){var f=t&&"boolean"==typeof t.isClient?!!t.isClient:!n.suspense,p=e.share(r),l=o(e.filter(i)(p)),v=e.map(a)(e.filter(u)(p));return f?v=e.tap(s)(v):l=e.tap(c)(l),e.merge([l,v])}};return f.restoreData=function(e){return o(r,e)},f.extractData=function(){return o({},r)},t&&t.initialState&&f.restoreData(t.initialState),f},exports.stringifyVariables=l,exports.subscriptionExchange=function(r){var n=r.forwardSubscription;return function(r){var i=r.client,a=r.forward;return function(r){var u=e.share(r),c=e.mergeMap((function(r){var a=r.key,c=e.filter((function(e){return"teardown"===e.operationName&&e.key===a}))(u);return e.takeUntil(c)(function(r){var a=n({key:r.key.toString(36),query:t.print(r.query),variables:r.variables,context:o({},r.context)});return e.make((function(e){var t=e[0],n=e[1],u=!1,c=a.subscribe({next:function(e){return t(x(r,e))},error:function(e){return t(m(r,e))},complete:function(){u||i.reexecuteOperation(o(o({},r),{operationName:"teardown"})),n()}});return function(){u=!0,c.unsubscribe()}}))}(r))}))(e.filter(V)(u)),s=a(e.filter(D)(u));return e.merge([c,s])}}},exports.useClient=ne,exports.useMutation=oe,exports.useQuery=pe,exports.useSubscription=de;
