import{make as t,subscribe as r,onEnd as e,onPush as n,toPromise as o,take as i,share as u,filter as a,map as c,tap as s,merge as f,mergeMap as p,takeUntil as v,switchMap as l,fromValue as d,interval as h,makeSubject as y,onStart as m,scan as x,concat as g}from"wonka";import{GraphQLError as O,parse as w,print as k,visit as q,Kind as b}from"graphql";import{createContext as E,useContext as N,useState as S,useCallback as P,useMemo as _,useRef as j}from"react";import{useSubjectValue as A}from"react-wonka";function Q(){return(Q=Object.assign||function(t){for(var r=1;r<arguments.length;r++){var e=arguments[r];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])}return t}).apply(this,arguments)}var C=function(t,r){var e="";return void 0!==t?e="[Network] "+t.message:(void 0!==r&&r.forEach((function(t){e+="[GraphQL] "+t.message+"\n"})),e.trim())},I=function(t){return"string"==typeof t?new O(t):"object"==typeof t&&t.message?new O(t.message,t.nodes,t.source,t.positions,t.path,t.originalError,t.extensions||{}):t};function R(){return this.message}var L=function(t){function r(r){var e=r.networkError,n=r.response,o=(r.graphQLErrors||[]).map(I),i=C(e,o);t.call(this,i),this.name="CombinedError",this.message=i,this.graphQLErrors=o,this.networkError=e,this.response=n}return t&&(r.__proto__=t),(r.prototype=Object.create(t&&t.prototype)).constructor=r,r.prototype.toString=R,r}(Error),F=function(t,r){t|=0;for(var e=0,n=0|r.length;e<n;e++)t=(t<<5)+t+r.charCodeAt(e);return t},M=new Set,D=function(t){if(void 0===t)return"";if("number"==typeof t)return isFinite(t)?""+t:"null";if("object"!=typeof t)return JSON.stringify(t);if(null===t)return"null";var r="";if(Array.isArray(t)){r="[";for(var e=0,n=t.length;e<n;e++){e>0&&(r+=",");var o=D(t[e]);r+=o.length>0?o:"null"}return r+"]"}if(M.has(t))throw new TypeError("Converting circular structure to JSON");var i=Object.keys(t).sort();M.add(t),r="{";for(var u=0,a=i.length;u<a;u++){var c=i[u],s=D(t[c]);0!==s.length&&(r.length>1&&(r+=","),r+=D(c)+":"+s)}return M.delete(t),r+"}"},T=function(t){return M.clear(),D(t)},$=function(t){return r=t.replace(/[\s,]+/g," ").trim(),F(5381,r)>>>0;var r},J=Object.create(null),G=function(t,r){var e,n;return"string"==typeof t?(e=$(t),n=void 0!==J[e]?J[e]:w(t)):void 0!==t.__key?(e=t.__key,n=t):(e=$(k(t)),n=void 0!==J[e]?J[e]:t),J[e]=n,n.__key=e,{key:r?F(e,T(r))>>>0:e,query:n,variables:r||{}}},z=function(t,r){return Q(Q({},t),{context:Q(Q({},t.context),{meta:Q(Q({},t.context.meta),r)})})},B=function(t,r,e){return{operation:t,data:r.data,error:Array.isArray(r.errors)?new L({graphQLErrors:r.errors,response:e}):void 0,extensions:"object"==typeof r.extensions&&null!==r.extensions?r.extensions:void 0}},H=function(t,r,e){return{operation:t,data:void 0,error:new L({networkError:r,response:e}),extensions:void 0}},K=function(t,r){if(void 0===r&&(r=[]),Array.isArray(t))t.forEach((function(t){K(t,r)}));else if("object"==typeof t&&null!==t)for(var e in t)if(Object.prototype.hasOwnProperty.call(t,e)){var n=t[e];"__typename"===e&&"string"==typeof n?r.push(n):"object"==typeof n&&null!==n&&K(n,r)}return r};function U(t,r,e){return e.indexOf(t)===r}var V=function(t){return K(t).filter(U)};function W(t){return"Field"===t.kind&&"__typename"===t.name.value}var X=function(t){return void 0!==t.selectionSet&&(t.selectionSet.selections.some(W)?t:Q(Q({},t),{selectionSet:Q(Q({},t.selectionSet),{selections:t.selectionSet.selections.concat([{kind:b.FIELD,name:{kind:b.NAME,value:"__typename"}}])})}))},Y=function(t){return q(t,{Field:X,InlineFragment:X})};function Z(t){return t.toPromise=function(){return o(i(1)(t))},t}var tt=function(t){var r=t.operationName;return"subscription"!==r&&"query"!==r};function rt(t){return""+t}var et=function(t){var r=t.error,e={data:t.data,error:void 0};return void 0!==r&&(e.error={networkError:""+r.networkError,graphQLErrors:r.graphQLErrors.map(rt)}),e},nt=function(t,r){var e=r.error,n={operation:t,data:r.data,extensions:void 0,error:void 0};return void 0!==e&&(n.error=new L({networkError:new Error(e.networkError),graphQLErrors:e.graphQLErrors})),n},ot=function(t){var r={},e=function(t){return!tt(t)&&void 0!==r[t.key]};function n(t){return!e(t)}function o(t){return nt(t,r[t.key])}function i(t){return e(t)}function p(t){var e=t.operation;if(!tt(e)){var n=et(t);r[e.key]=n}}function v(t){delete r[t.operation.key]}var l=function(r){var e=r.client,l=r.forward;return function(r){var d=t&&"boolean"==typeof t.isClient?!!t.isClient:!e.suspense,h=u(r),y=l(a(n)(h)),m=c(o)(a(i)(h));return d?m=s(v)(m):y=s(p)(y),f([y,m])}};return l.restoreData=function(t){return Q(r,t)},l.extractData=function(){return Q({},r)},t&&t.initialState&&l.restoreData(t.initialState),l},it=function(t){var r=t.operationName;return"mutation"!==r&&"query"!==r};function ut(t){return Q(Q({},t),{query:Y(t.query)})}function at(t){return z(t,{cacheOutcome:"miss"})}function ct(t){return it(t)}var st=function(t){var r=t.forward,e=t.client,n=new Map,o=Object.create(null),i=ut,p=pt(n,o,e),v=vt(n,o),l=function(t){var r=t.context.requestPolicy;return"query"===t.operationName&&"network-only"!==r&&("cache-only"===r||n.has(t.key))};function d(t){var r=n.get(t.key),o=Q(Q({},r),{operation:z(t,{cacheOutcome:r?"hit":"miss"})});return"cache-and-network"===t.context.requestPolicy&&(o.stale=!0,ft(e,t)),o}function h(t){return!it(t)&&l(t)}function y(t){t.operation&&"mutation"===t.operation.operationName?p(t):t.operation&&"query"===t.operation.operationName&&v(t)}function m(t){return!it(t)&&!l(t)}return function(t){var e=u(t),n=c(d)(a(h)(e)),o=s(y)(r(c(at)(f([c(i)(a(m)(e)),a(ct)(e)]))));return f([n,o])}},ft=function(t,r){return t.reexecuteOperation(Q(Q({},r),{context:Q(Q({},r.context),{requestPolicy:"network-only"})}))},pt=function(t,r,e){function n(r){if(t.has(r)){var n=t.get(r).operation;t.delete(r),ft(e,n)}}return function(t){var e=new Set;function o(t){e.add(t)}V(t.data).forEach((function(t){var e=r[t]||(r[t]=new Set);e.forEach(o),e.clear()})),e.forEach(n)}},vt=function(t,r){return function(e){var n=e.operation,o=e.data;null!=o&&(t.set(n.key,{operation:n,data:o,error:e.error}),V(e.data).forEach((function(t){(r[t]||(r[t]=new Set)).add(n.key)})))}},lt=function(t){return"subscription"===t.operationName};function dt(t){return!lt(t)}var ht=function(r){var e=r.forwardSubscription;return function(r){var n=r.client,o=r.forward;return function(r){var i=u(r),c=p((function(r){var o=r.key,u=a((function(t){return"teardown"===t.operationName&&t.key===o}))(i);return v(u)(function(r){var o=e({key:r.key.toString(36),query:k(r.query),variables:r.variables,context:Q({},r.context)});return t((function(t){var e=t[0],i=t[1],u=!1,a=o.subscribe({next:function(t){return e(B(r,t))},error:function(t){return e(H(r,t))},complete:function(){u||n.reexecuteOperation(Q(Q({},r),{operationName:"teardown"})),i()}});return function(){u=!0,a.unsubscribe()}}))}(r))}))(a(lt)(i)),s=o(a(dt)(i));return f([c,s])}}},yt=function(t){var r=t.forward;return function(t){return r(t)}},mt=function(t){var r=t.forward,e=new Set,n=function(t){var r=t.key,n=t.operationName;if("teardown"===n)return e.delete(r),!0;if("query"!==n)return!0;var o=e.has(r);return e.add(r),!o},o=function(t){e.delete(t.operation.key)};return function(t){var e=a(n)(t);return s(o)(r(e))}};function xt(t){var r=t.operationName;return"query"===r||"mutation"===r}var gt=function(t){var r=t.forward,e=xt;function n(t){return!e(t)}return function(t){var o=u(t),i=p((function(t){var r=t.key,e=a((function(t){return"teardown"===t.operationName&&t.key===r}))(o);return v(e)(wt(t))}))(a(e)(o)),c=r(a(n)(o));return f([i,c])}};function Ot(t){return t.kind===b.OPERATION_DEFINITION&&t.name}var wt=function(r){return t((function(t){var e,n=t[0],o=t[1],i="undefined"!=typeof AbortController?new AbortController:void 0,u=r.context,a="function"==typeof u.fetchOptions?u.fetchOptions():u.fetchOptions||{},c=void 0!==(e=r.query.definitions.find(Ot))&&e.name?e.name.value:null,s={query:k(r.query),variables:r.variables};null!==c&&(s.operationName=c);var f=Q(Q({body:JSON.stringify(s),method:"POST"},a),{headers:Q({"content-type":"application/json"},a.headers),signal:void 0!==i?i.signal:void 0});return kt(r,f).then((function(t){void 0!==t&&n(t),o()})),function(){void 0!==i&&i.abort()}}))},kt=function(t,r){var e,n=t.context;return(n.fetch||fetch)(n.url,r).then((function(t){var n=t.status;if(e=t,n<200||n>=("manual"===r.redirect?400:300))throw new Error(t.statusText);return t.json()})).then((function(r){return B(t,r,e)})).catch((function(r){if("AbortError"!==r.name)return H(t,r,e)}))};function qt(){return!1}function bt(t){}var Et=function(t){return a(qt)(s(bt)(t))},Nt=function(t){return 1===t.length?t[0]:function(r){var e=r.client;return t.reduceRight((function(t,r){return r({client:e,forward:t})}),r.forward)}},St=[mt,st,gt],Pt=function(t){return new _t(t)},_t=function(t){var r=this;this.activeOperations=Object.create(null),this.createOperationContext=function(t){var e=(t||{}).requestPolicy;return void 0===e&&(e=r.requestPolicy),Q(Q({url:r.url,fetchOptions:r.fetchOptions,fetch:r.fetch},t),{requestPolicy:e})},this.createRequestOperation=function(t,e,n){return{key:e.key,query:e.query,variables:e.variables,operationName:t,context:r.createOperationContext(n)}},this.reexecuteOperation=function(t){(r.activeOperations[t.key]||0)>0&&r.dispatchOperation(t)},this.executeQuery=function(t,e){var n=r.createRequestOperation("query",t,e),o=r.executeRequestOperation(n),i=n.context.pollInterval;return i?l((function(){return o}))(f([d(0),h(i)])):o},this.executeSubscription=function(t,e){var n=r.createRequestOperation("subscription",t,e);return r.executeRequestOperation(n)},this.executeMutation=function(t,e){var n=r.createRequestOperation("mutation",t,e);return r.executeRequestOperation(n)},this.url=t.url,this.fetchOptions=t.fetchOptions,this.fetch=t.fetch,this.suspense=!!t.suspense,this.requestPolicy=t.requestPolicy||"cache-first";var e=y(),n=e[1];this.operations$=e[0];var o=[],i=!1;this.dispatchOperation=function(t){if(o.push(t),!i){var r;for(i=!0;void 0!==(r=o.shift());)n(r);i=!1}},this.exchange=Nt(void 0!==t.exchanges?t.exchanges:St),this.results$=u(this.exchange({client:this,forward:Et})(this.operations$))};_t.prototype.onOperationStart=function(t){var r=t.key;this.activeOperations[r]=(this.activeOperations[r]||0)+1,this.dispatchOperation(t)},_t.prototype.onOperationEnd=function(t){var r=t.key,e=this.activeOperations[r]||0;(this.activeOperations[r]=e<=0?0:e-1)<=0&&this.dispatchOperation(Q(Q({},t),{operationName:"teardown"}))},_t.prototype.executeRequestOperation=function(o){var u=this,c=o.key,s=o.operationName,f=a((function(t){return t.operation.key===c}))(this.results$);if("mutation"===s)return i(1)(m((function(){return u.dispatchOperation(o)}))(f));var p,l=a((function(t){return"teardown"===t.operationName&&t.key===c}))(this.operations$),d=e((function(){return u.onOperationEnd(o)}))(m((function(){return u.onOperationStart(o)}))(v(l)(f)));return!1!==o.context.suspense&&this.suspense&&"query"===s?(p=d,t((function(t){var o,i,u=t[0],a=t[1],c=!1,s=r((function(t){void 0===o?i=t:c||(o(t),a(),s())}))(e(a)(n(u)(p)))[0];if(void 0===i)throw new Promise((function(t){o=t}));return function(){c=!0,s()}}))):d},_t.prototype.query=function(t,r,e){return e&&"boolean"==typeof e.suspense||(e=Q(Q({},e),{suspense:!1})),Z(this.executeQuery(G(t,r),e))},_t.prototype.mutation=function(t,r,e){return Z(this.executeMutation(G(t,r),e))};var jt=E(Pt({url:"/graphql"})),At=jt.Provider,Qt=jt.Consumer,Ct=function(){return N(jt)},It=function(t){var r=Ct(),e=S({fetching:!1,stale:!1,error:void 0,data:void 0,extensions:void 0}),n=e[1];function i(t){return n({fetching:!1,stale:!!t.stale,data:t.data,error:t.error,extensions:t.extensions}),t}return[e[0],P((function(e,u){n({fetching:!0,stale:!1,error:void 0,data:void 0,extensions:void 0});var a=G(t,e);return o(r.executeMutation(a,u||{})).then(i)}),[r,t,n])]},Rt=function(t,r){var e=j(void 0);return _((function(){var n=G(t,r);return void 0!==e.current&&e.current.key===n.key?e.current:(e.current=n,n)}),[t,r])},Lt={fetching:!1,stale:!1,data:void 0,error:void 0,extensions:void 0};function Ft(t,r){return Q(Q(Q({},t),{stale:!1}),r)}function Mt(t){return{fetching:!1,stale:!!t.stale,data:t.data,error:t.error,extensions:t.extensions}}function Dt(t){return t?g([d({fetching:!0}),c(Mt)(t),d({fetching:!1})]):d({fetching:!1})}function Tt(t){return x(Ft,Lt)(l(Dt)(t))}var $t=function(t){var r=Ct(),e=Rt(t.query,t.variables);function n(n){return r.executeQuery(e,Q(Q({requestPolicy:t.requestPolicy,pollInterval:t.pollInterval},t.context),n))}var o=_((function(){return n}),[r,e,t.requestPolicy,t.pollInterval,t.context]),i=A(Tt,_((function(){return t.pause?null:o()}),[t.pause,o]),Lt),u=i[1];return[i[0],P((function(t){return u(o(t))}),[u,o])]},Jt={fetching:!1,stale:!1,data:void 0,error:void 0,extensions:void 0};function Gt(t){return{fetching:!0,stale:!!t.stale,data:t.data,error:t.error,extensions:t.extensions}}function zt(t){return t?g([d({fetching:!0}),c(Gt)(t),d({fetching:!1})]):d({fetching:!1})}var Bt=function(t,r){var e=Ct(),n=j(r);n.current=r;var o=Rt(t.query,t.variables);function i(r){return e.executeSubscription(o,Q(Q({},t.context),r))}var u=_((function(){return i}),[e,o,t.context]);function a(t,r){var e=n.current,o=void 0!==r.data?"function"==typeof e?e(t.data,r.data):r.data:t.data;return Q(Q(Q(Q({},t),{stale:!1}),r),{data:o})}var c=A((function(t){return x(a,Jt)(l(zt)(t))}),_((function(){return t.pause?null:u()}),[t.pause,u]),Jt),s=c[1];return[c[0],P((function(t){return s(u(t))}),[s,u])]};function Ht(t){var r=t.children,e=It(t.query),n=e[1];return r(Q(Q({},e[0]),{executeMutation:n}))}function Kt(t){var r=$t(t),e=r[1];return t.children(Q(Q({},r[0]),{executeQuery:e}))}function Ut(t){var r=Bt(t,t.handler),e=r[1];return t.children(Q(Q({},r[0]),{executeSubscription:e}))}export{_t as Client,L as CombinedError,Qt as Consumer,jt as Context,Ht as Mutation,At as Provider,Kt as Query,Ut as Subscription,st as cacheExchange,Nt as composeExchanges,Pt as createClient,G as createRequest,yt as debugExchange,mt as dedupExchange,St as defaultExchanges,Et as fallbackExchangeIO,gt as fetchExchange,Y as formatDocument,H as makeErrorResult,B as makeResult,ot as ssrExchange,T as stringifyVariables,ht as subscriptionExchange,Ct as useClient,It as useMutation,$t as useQuery,Bt as useSubscription};
